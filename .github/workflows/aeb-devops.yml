name: AEB DevOps – 7 Layer Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

env:
  ROS_DISTRO: humble
  PYTHON_VERSION: "3.10"
  AEB_WS: aeb_ws

jobs:

# --------------------------------
# LAYER 1 – VERSIONING & TRACEABILITY

  layer1_versioning:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Validate registries and configs
        run: |
          python scripts/validate_json.py

      - name: Generate CI traceability record
        run: |
          python scripts/generate_ci_result.py

      - name: Upload layer-1 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: layer1-artifacts
          path: artifacts/

# --------------------------------
# LAYER 2 – MODEL-AWARE CI

  layer2_ci:
    runs-on: ubuntu-22.04
    needs: layer1_versioning

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup ROS 2 Humble
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: humble

      - name: Build ROS2 workspace
        run: |
          source /opt/ros/humble/setup.bash
          cd aeb_ws
          colcon build  
         
      - name: Run unit and chain tests
        run: |
          source /opt/ros/humble/setup.bash
          cd aeb_ws
          source install/setup.bash
          pytest ../tests


# --------------------------------
# LAYER 3 – SIL INTEGRATION

  layer3_sil:
    runs-on: ubuntu-22.04
    needs: layer2_ci

    steps:
      - uses: actions/checkout@v4

      - name: Run SIL tests
        run: |
          python scripts/run_sil.py

      - name: Upload SIL artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sil-results
          path: artifacts/sil_results.json

# --------------------------------
# LAYER 4 – SIMULATION VALIDATION

  layer4_simulation:
    runs-on: ubuntu-22.04
    needs: layer3_sil

    steps:
      - uses: actions/checkout@v4

      - name: Run scenario simulations
        run: |
          python scripts/run_simulation.py

      - name: Upload simulation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simulation-results
          path: artifacts/simulation_results.json

# --------------------------------
# LAYER 5 – SAFETY & COMPLIANCE GATE

  layer5_safety_gate:
    runs-on: ubuntu-22.04
    needs: layer4_simulation

    steps:
      - uses: actions/checkout@v4

      - name: Execute safety gate
        run: |
          python scripts/safety_gate.py

# --------------------------------
# LAYER 6 – CONTROLLED DELIVERY

  layer6_release:
    runs-on: ubuntu-22.04
    needs: layer5_safety_gate

    steps:
      - uses: actions/checkout@v4

      - name: Create validated release artifact
        run: |
          python scripts/create_release.py

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: aeb-release
          path: release/

# --------------------------------
# LAYER 7 – CONTINUOUS FEEDBACK LOOP

  layer7_feedback:
    runs-on: ubuntu-22.04
    needs: layer6_release

    steps:
      - uses: actions/checkout@v4

      - name: Feedback loop placeholder
        run: |
          echo "Feedback loop complete – ready for retraining & scenario updates"
