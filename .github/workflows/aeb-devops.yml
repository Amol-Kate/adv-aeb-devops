name: AEB DevOps Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - "aeb_ws/**"
      - "models/**"
      - "data/**"
      - "scenarios/**"
      - "scripts/**"
  pull_request:
    branches: [ main ]

env:
  ROS_DISTRO: humble
  WORKSPACE: aeb_ws
  PACKAGE: aeb_system
  PYTHON_VERSION: "3.10"

# ---------------------------------------------------------
# LAYER 1: UNIFIED VERSIONING & TRACEABILITY

jobs:
  layer1-versioning:
    name: L1 – Unified Versioning & Traceability
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Capture code version
        run: |
          echo "CODE_COMMIT=${GITHUB_SHA}" >> trace.env

      - name: Capture model versions
        run: |
          ls models > model_versions.txt || true

      - name: Capture data versions (DVC)
        run: |
          if [ -f data.dvc ]; then
            dvc status > data_versions.txt
          fi

      - name: Capture scenario versions
        run: |
          ls scenarios > scenario_versions.txt || true

      - name: Store lineage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lineage
          path: |
            trace.env
            model_versions.txt
            data_versions.txt
            scenario_versions.txt


# ---------------------------------------------------------
# LAYER 2: MODEL-AWARE CI

  layer2-model-aware-ci:
    name: L2 – Model-Aware CI
    runs-on: ubuntu-latest
    needs: layer1-versioning

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Static & safety analysis
        run: |
          pip install flake8
          flake8 $WORKSPACE/src/${{ env.PACKAGE }} || true

      - name: Setup ROS2
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ env.ROS_DISTRO }}

      - name: Build ROS2 stack
        run: |
          source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash
          cd $WORKSPACE
          colcon build

      - name: Run unit tests
        run: |
          source /opt/ros/${{ env.ROS_DISTRO }}/setup.bash
          cd $WORKSPACE
          colcon test --packages-select ${{ env.PACKAGE }}

      - name: Model compatibility & drift check
        run: |
          python scripts/model_compatibility_check.py || true


# ---------------------------------------------------------
# LAYER 3: VIRTUALIZED SYSTEM INTEGRATION

  layer3-virtual-integration:
    name: L3 – Virtualized System Integration (SIL)
    runs-on: ubuntu-latest
    needs: layer2-model-aware-ci

    steps:
      - uses: actions/checkout@v4

      - name: Build containerized AV stack
        run: |
          docker build -t aeb-sil -f docker/Dockerfile.sil .

      - name: Run SIL stack
        run: |
          docker run --rm aeb-sil echo "SIL system booted"


# ---------------------------------------------------------
# LAYER 4: SIMULATION-DRIVEN VALIDATION

  layer4-simulation:
    name: L4 – Simulation-Driven Validation
    runs-on: ubuntu-latest
    needs: layer3-virtual-integration

    steps:
      - uses: actions/checkout@v4

      - name: Run CARLA scenarios
        run: |
          python scripts/run_carla_scenarios.py \
            --scenarios scenarios/ \
            --weather rain,fog,night \
            --output sim_results/

      - name: Upload simulation logs
        uses: actions/upload-artifact@v4
        with:
          name: simulation-results
          path: sim_results/


# ---------------------------------------------------------
# LAYER 5: SAFETY & COMPLIANCE GATES

  layer5-safety-gate:
    name: L5 – Safety & Compliance Gates
    runs-on: ubuntu-latest
    needs: layer4-simulation

    steps:
      - uses: actions/checkout@v4

      - name: Evaluate safety KPIs
        run: |
          python scripts/safety_kpi_evaluator.py sim_results/

      - name: Check regression & coverage
        run: |
          python scripts/scenario_coverage_check.py sim_results/

      - name: ISO 26262 / SOTIF evidence check
        run: |
          python scripts/compliance_check.py


# ---------------------------------------------------------
# LAYER 6: CONTROLLED CONTINUOUS DELIVERY
# 
  layer6-controlled-cd:
    name: L6 – Controlled Continuous Delivery
    runs-on: ubuntu-latest
    needs: layer5-safety-gate
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Create validated release artifact
        run: |
          python scripts/create_release.py

      - name: Tag release candidate
        run: |
          git tag -a "RC-${GITHUB_RUN_NUMBER}" -m "Safety-approved RC"

      - uses: actions/upload-artifact@v4
        with:
          name: release-candidate
          path: release/


# ---------------------------------------------------------
# LAYER 7: CONTINUOUS LEARNING & FEEDBACK LOOP
# 
  layer7-learning:
    name: L7 – Continuous Learning & Feedback
    runs-on: ubuntu-latest
    needs: layer6-controlled-cd

    steps:
      - uses: actions/checkout@v4

      - name: Ingest fleet telemetry
        run: |
          python scripts/ingest_fleet_logs.py || true

      - name: Mine failure patterns
        run: |
          python scripts/failure_pattern_mining.py || true

      - name: Generate new scenarios & data
        run: |
          python scripts/generate_new_scenarios.py || true

      - name: Feedback to Layer 1 & 2
        run: |
          echo "Feedback loop closed: new data & scenarios available"
